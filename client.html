<html>
	<head>
		<title>SharedBoard</title>
		<script src="/socket.io.js"></script>
		<style>
			html,
			body {
				margin: 0;
				height: 100%;
				overflow: hidden;
			}
		</style>
	</head>
	<body>
		<canvas id="canvas"></canvas>
		<script>
			const DRAW_FPS = 60;
			const MSG_FPS = 20;
			
			const WIDTH = 1900;
			const HEIGHT = 1000;
			
			const X_RATIO = window.innerWidth / WIDTH;
			const Y_RATIO = window.innerHeight / HEIGHT;
			
			var lines = [];
			
			var canvas = document.getElementById("canvas");
			
			canvas.style.width = window.innerWidth;
			canvas.style.height = window.innerHeight; 
			
			canvas.width = WIDTH;
			canvas.height = HEIGHT;
			
			var ctx = canvas.getContext("2d");
			
			ctx.lineWidth = 3;
			
			var drawing = false;
			var mousePos = { x:0, y:0 };
			var lastPos = mousePos;
			
			canvas.addEventListener("mousedown", function (e) {
				mousePos = getMousePos(e);
				lastPos = mousePos;
				drawing = true;
			}, false);
			
			canvas.addEventListener("mouseup", function (e) {
				drawing = false;
			}, false);
			
			canvas.addEventListener("mousemove", function (e) {
				mousePos = getMousePos(e);
			}, false);

			function getMousePos(e) {
				var rect = canvas.getBoundingClientRect();
				return { x: (e.clientX - rect.left) / X_RATIO, y: (e.clientY - rect.top) / Y_RATIO };
			}
			
			
			
			canvas.addEventListener("touchstart", function (e) {
				console.log('touch');
				var mouseEvent = new MouseEvent("mousedown", {
					clientX: e.touches[0].clientX,
					clientY: e.touches[0].clientY
				});
				canvas.dispatchEvent(mouseEvent);
			}, false);
			
			canvas.addEventListener("touchend", function (e) {
				var mouseEvent = new MouseEvent("mouseup", {});
				canvas.dispatchEvent(mouseEvent);
			}, false);
			
			canvas.addEventListener("touchmove", function (e) {
				var touch = e.touches[0];
				var mouseEvent = new MouseEvent("mousemove", {
					clientX: touch.clientX,
					clientY: touch.clientY
				});
				canvas.dispatchEvent(mouseEvent);
			}, false);
			
			document.body.addEventListener("touchstart", function (e) {
				if (e.target == canvas) {
					e.preventDefault();
				}
			}, false);
			
			document.body.addEventListener("touchend", function (e) {
				if (e.target == canvas) {
					e.preventDefault();
				}
			}, false);
			
			document.body.addEventListener("touchmove", function (e) {
				if (e.target == canvas) {
					e.preventDefault();
				}
			}, false);
			
			
			
			function renderCanvas() {
				if (drawing && lastPos != mousePos) {
					ctx.moveTo(lastPos.x, lastPos.y);
					ctx.lineTo(mousePos.x, mousePos.y);
					ctx.stroke();
					
					lines.push({x0 : lastPos.x, y0 : lastPos.y, x1 : mousePos.x, y1 : mousePos.y});
					
					lastPos = mousePos;
				}
			}
			
			(function drawLoop () {
				window.setTimeout(drawLoop, 1000 / DRAW_FPS);
				renderCanvas();
			})();
			
			var socket = io.connect('https://sharedboardgm.herokuapp.com/');
			socket.on('lines', function(lines){
				for (i in lines)
				{
					ctx.moveTo(lines[i].x0, lines[i].y0);
					ctx.lineTo(lines[i].x1, lines[i].y1);
					ctx.stroke();
				}
			});
			
			function sendLines(){
				var toSend = lines;
				lines = [];
				if(toSend.length > 0){
					socket.emit('lines', toSend);
				}
			}
			
			(function msgLoop () {
				window.setTimeout(msgLoop, 1000 / MSG_FPS);
				sendLines();
			})();
		</script>
	</body>
</html>